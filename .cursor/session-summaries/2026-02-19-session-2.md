# Session Summary â€” 2026-02-19 (Delete Single Message)

## Accomplished

Implemented **delete single message** (WhatsApp/Telegram-style):

- **Delete for me:** Long-press any message -> "Delete for me". Message is hidden only for the current user (stored in `messages.hiddenByUserIds`).
- **Delete for everyone:** Long-press own message -> "Delete for everyone". Message is hard-deleted; only the sender can do this. Recipient receives `messageDeleted` via WebSocket.

### Backend

- `message.entity.ts`: Added `hiddenByUserIds` (varchar, comma-separated user IDs).
- `messages.service.ts`: Added `parseHiddenIds`, `findByIdWithConversation`, `hideMessageForUser`, `deleteById`. Updated `findByConversation`, `getLastMessage`, `countUnreadForRecipient` to filter by hiddenByUserIds.
- `chat-message.service.ts`: Added `handleDeleteMessage`. Updated `handleGetMessages` to pass userId for filtering.
- `chat-conversation.service.ts`: Pass userId to `getLastMessage`.
- `delete-message.dto.ts`: New DTO with messageId, mode ('for_me' | 'for_everyone').
- `chat.gateway.ts`: Added `@SubscribeMessage('deleteMessage')`.

### Frontend

- `socket_service.dart`: Added `emitDeleteMessage`, `onMessageDeleted` callback.
- `chat_provider.dart`: Added `deleteMessage`, `_handleMessageDeleted`.
- `chat_message_bubble.dart`: Long-press -> modal bottom sheet with "Delete for me" / "Delete for everyone".
- `voice_message_bubble.dart`: Same long-press behavior.

### Documentation

- Updated `CLAUDE.md` with schema, WebSocket events, DTOs, feature description.

## Key Files Modified

- `backend/src/messages/message.entity.ts`
- `backend/src/messages/messages.service.ts`
- `backend/src/chat/dto/delete-message.dto.ts`
- `backend/src/chat/chat.gateway.ts`
- `backend/src/chat/services/chat-message.service.ts`
- `backend/src/chat/services/chat-conversation.service.ts`
- `frontend/lib/services/socket_service.dart`
- `frontend/lib/providers/chat_provider.dart`
- `frontend/lib/widgets/chat_message_bubble.dart`
- `frontend/lib/widgets/voice_message_bubble.dart`
- `CLAUDE.md`

## Project Status

Feature complete. Backend tests pass. Restart backend (Docker) to apply `hiddenByUserIds` column via TypeORM synchronize.
