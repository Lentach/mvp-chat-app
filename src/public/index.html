<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚öîÔ∏è RPG Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <style>
    /* === RESET & BASE === */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      color: #e0e0e0;
      background: #0a0a2e;
      /* Subtelne gwiazdy w tle */
      background-image:
        radial-gradient(1px 1px at 10% 20%, #ffffff44, transparent),
        radial-gradient(1px 1px at 30% 70%, #ffffff33, transparent),
        radial-gradient(1px 1px at 50% 40%, #ffffff22, transparent),
        radial-gradient(1px 1px at 70% 80%, #ffffff44, transparent),
        radial-gradient(1px 1px at 90% 10%, #ffffff33, transparent),
        radial-gradient(1px 1px at 15% 90%, #ffffff22, transparent),
        radial-gradient(1px 1px at 85% 50%, #ffffff44, transparent),
        radial-gradient(1px 1px at 45% 15%, #ffffff33, transparent);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      image-rendering: pixelated;
    }

    /* === RPG DIALOG BOX ‚Äî pikselowa ramka === */
    .rpg-box {
      background: #0f0f3d;
      border: 4px solid #4a4ae0;
      border-radius: 2px;
      padding: 20px;
      position: relative;
      /* Podw√≥jna ramka w stylu FF */
      box-shadow:
        inset 0 0 0 2px #0f0f3d,
        inset 0 0 0 4px #7b7bf5,
        0 0 20px #1a1a5e88;
    }

    .rpg-box::before {
      content: '';
      position: absolute;
      inset: -8px;
      border: 3px solid #2a2a7a;
      border-radius: 4px;
      pointer-events: none;
    }

    /* === TITLE === */
    .title {
      text-align: center;
      color: #ffcc00;
      font-size: 16px;
      text-shadow: 2px 2px 0 #aa6600, 0 0 10px #ffcc0066;
      margin-bottom: 8px;
      letter-spacing: 2px;
    }

    .subtitle {
      text-align: center;
      color: #7b7bf5;
      font-size: 8px;
      margin-bottom: 20px;
    }

    /* === AUTH SCREEN === */
    #auth-screen {
      width: 400px;
    }

    .tab-bar {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
    }

    .tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      font-family: 'Press Start 2P', monospace;
      font-size: 9px;
      background: #1a1a4e;
      color: #6a6ab0;
      border: 2px solid #3a3a8a;
      cursor: pointer;
      transition: all 0.1s;
    }

    .tab:hover {
      background: #2a2a6e;
    }

    .tab.active {
      background: #2a2a8e;
      color: #ffcc00;
      border-color: #ffcc00;
      text-shadow: 0 0 6px #ffcc0066;
    }

    .form-group {
      margin-bottom: 14px;
    }

    .form-group label {
      display: block;
      color: #9999dd;
      font-size: 8px;
      margin-bottom: 6px;
    }

    .form-group input {
      width: 100%;
      padding: 10px;
      font-family: 'Press Start 2P', monospace;
      font-size: 9px;
      background: #0a0a24;
      color: #ffffff;
      border: 2px solid #3a3a8a;
      outline: none;
    }

    .form-group input:focus {
      border-color: #ffcc00;
      box-shadow: 0 0 8px #ffcc0044;
    }

    .btn {
      width: 100%;
      padding: 12px;
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      cursor: pointer;
      border: 3px solid;
      transition: all 0.1s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-primary {
      background: #2a2a8e;
      color: #ffcc00;
      border-color: #ffcc00;
    }

    .btn-primary:hover {
      background: #3a3a9e;
      box-shadow: 0 0 12px #ffcc0044;
    }

    .btn-primary:active {
      transform: scale(0.97);
    }

    .status-msg {
      text-align: center;
      font-size: 8px;
      margin-top: 10px;
      min-height: 14px;
    }

    .status-msg.error { color: #ff4444; text-shadow: 0 0 6px #ff444444; }
    .status-msg.success { color: #44ff44; text-shadow: 0 0 6px #44ff4444; }

    /* === CHAT SCREEN === */
    #chat-screen {
      display: none;
      width: 700px;
      height: 520px;
      padding: 16px;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #3a3a8a;
    }

    .chat-header .user-info {
      color: #44ff44;
      font-size: 8px;
      text-shadow: 0 0 6px #44ff4444;
    }

    .btn-small {
      padding: 6px 10px;
      font-family: 'Press Start 2P', monospace;
      font-size: 7px;
      background: #1a1a4e;
      color: #ff6666;
      border: 2px solid #ff6666;
      cursor: pointer;
    }

    .btn-small:hover {
      background: #2a1a3e;
    }

    .chat-layout {
      display: flex;
      gap: 10px;
      height: calc(100% - 50px);
    }

    /* Sidebar ‚Äî lista konwersacji / nowy czat */
    .sidebar {
      width: 200px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar-title {
      color: #ffcc00;
      font-size: 8px;
      text-align: center;
      padding: 6px;
      border-bottom: 2px solid #3a3a8a;
    }

    .new-chat-input {
      display: flex;
      gap: 4px;
    }

    .new-chat-input input {
      flex: 1;
      padding: 6px;
      font-family: 'Press Start 2P', monospace;
      font-size: 7px;
      background: #0a0a24;
      color: #fff;
      border: 2px solid #3a3a8a;
      outline: none;
    }

    .new-chat-input input:focus {
      border-color: #ffcc00;
    }

    .new-chat-input button {
      padding: 6px 8px;
      font-family: 'Press Start 2P', monospace;
      font-size: 8px;
      background: #2a2a8e;
      color: #ffcc00;
      border: 2px solid #ffcc00;
      cursor: pointer;
    }

    .conv-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .conv-item {
      padding: 8px;
      font-size: 7px;
      background: #1a1a4e;
      border: 2px solid #2a2a6e;
      cursor: pointer;
      color: #9999dd;
      word-break: break-all;
    }

    .conv-item:hover {
      border-color: #7b7bf5;
      color: #fff;
    }

    .conv-item.active {
      border-color: #ffcc00;
      color: #ffcc00;
      background: #2a2a6e;
    }

    /* Obszar wiadomo≈õci */
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      background: #08081e;
      border: 2px solid #2a2a6e;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .messages-area::-webkit-scrollbar { width: 8px; }
    .messages-area::-webkit-scrollbar-track { background: #0a0a24; }
    .messages-area::-webkit-scrollbar-thumb { background: #3a3a8a; }

    /* Wiadomo≈õƒá jako RPG dialog box */
    .message {
      max-width: 80%;
      padding: 8px 10px;
      font-size: 8px;
      line-height: 1.6;
      border: 2px solid #3a3a8a;
      background: #121240;
      position: relative;
    }

    .message .sender {
      font-size: 7px;
      margin-bottom: 4px;
      display: block;
    }

    .message .time {
      font-size: 6px;
      color: #5555aa;
      margin-top: 4px;
      display: block;
      text-align: right;
    }

    /* Moja wiadomo≈õƒá ‚Äî wyr√≥wnana do prawej, z≈Çoty border */
    .message.mine {
      align-self: flex-end;
      border-color: #ffcc00;
      background: #1a1a50;
    }

    .message.mine .sender {
      color: #ffcc00;
    }

    /* Wiadomo≈õƒá drugiej osoby ‚Äî wyr√≥wnana do lewej, fioletowy border */
    .message.theirs {
      align-self: flex-start;
      border-color: #7b7bf5;
    }

    .message.theirs .sender {
      color: #7b7bf5;
    }

    /* Input do wysy≈Çania wiadomo≈õci */
    .message-input-bar {
      display: flex;
      gap: 6px;
    }

    .message-input-bar input {
      flex: 1;
      padding: 10px;
      font-family: 'Press Start 2P', monospace;
      font-size: 9px;
      background: #0a0a24;
      color: #fff;
      border: 2px solid #3a3a8a;
      outline: none;
    }

    .message-input-bar input:focus {
      border-color: #ffcc00;
      box-shadow: 0 0 8px #ffcc0044;
    }

    .message-input-bar button {
      padding: 10px 16px;
      font-family: 'Press Start 2P', monospace;
      font-size: 9px;
      background: #2a2a8e;
      color: #ffcc00;
      border: 3px solid #ffcc00;
      cursor: pointer;
    }

    .message-input-bar button:hover {
      background: #3a3a9e;
      box-shadow: 0 0 10px #ffcc0044;
    }

    .no-chat-selected {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #3a3a8a;
      font-size: 9px;
      text-align: center;
      line-height: 2;
    }

    /* Animacja migajƒÖcego kursora */
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    .blink {
      animation: blink 1s step-end infinite;
    }
  </style>
</head>
<body>

  <!-- ============ AUTH SCREEN ============ -->
  <div id="auth-screen" class="rpg-box">
    <div class="title">‚öîÔ∏è RPG CHAT ‚öîÔ∏è</div>
    <div class="subtitle">~ Enter the realm ~</div>

    <div class="tab-bar">
      <div class="tab active" data-tab="login">LOGIN</div>
      <div class="tab" data-tab="register">REGISTER</div>
    </div>

    <!-- Login form -->
    <form id="login-form">
      <div class="form-group">
        <label>üìß EMAIL</label>
        <input type="email" id="login-email" placeholder="hero@quest.com" required>
      </div>
      <div class="form-group">
        <label>üîë PASSWORD</label>
        <input type="password" id="login-password" placeholder="******" required>
      </div>
      <button type="submit" class="btn btn-primary">‚ñ∂ ENTER REALM</button>
    </form>

    <!-- Register form -->
    <form id="register-form" style="display:none">
      <div class="form-group">
        <label>üìß EMAIL</label>
        <input type="email" id="reg-email" placeholder="hero@quest.com" required>
      </div>
      <div class="form-group">
        <label>üîë PASSWORD (min 6)</label>
        <input type="password" id="reg-password" placeholder="******" minlength="6" required>
      </div>
      <button type="submit" class="btn btn-primary">‚ú¶ CREATE HERO</button>
    </form>

    <div id="auth-status" class="status-msg"></div>
  </div>

  <!-- ============ CHAT SCREEN ============ -->
  <div id="chat-screen" class="rpg-box">
    <div class="chat-header">
      <div class="user-info">‚öîÔ∏è <span id="user-email"></span> <span class="blink">_</span></div>
      <button class="btn-small" id="logout-btn">‚úñ LOGOUT</button>
    </div>

    <div class="chat-layout">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-title">üìú PARTY</div>
        <div class="new-chat-input">
          <input type="text" id="new-chat-email" placeholder="email...">
          <button id="start-chat-btn">+</button>
        </div>
        <div class="conv-list" id="conv-list"></div>
      </div>

      <!-- Chat area -->
      <div class="chat-main" id="chat-main">
        <div class="no-chat-selected" id="no-chat-msg">
          Select a party member<br>or start a new quest<br><br>‚öîÔ∏è
        </div>
        <div class="messages-area" id="messages-area" style="display:none"></div>
        <div class="message-input-bar" id="message-bar" style="display:none">
          <input type="text" id="msg-input" placeholder="Type your message...">
          <button id="send-btn">SEND</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === STATE ===
    let token = null;
    let currentUser = null; // { id, email }
    let socket = null;
    let activeConversationId = null;
    let conversations = []; // [{ id, userOne, userTwo }]

    const API = '';

    // === DOM ELEMENTS ===
    const authScreen = document.getElementById('auth-screen');
    const chatScreen = document.getElementById('chat-screen');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const authStatus = document.getElementById('auth-status');
    const userEmailSpan = document.getElementById('user-email');
    const convListEl = document.getElementById('conv-list');
    const messagesArea = document.getElementById('messages-area');
    const noChatMsg = document.getElementById('no-chat-msg');
    const messageBar = document.getElementById('message-bar');
    const msgInput = document.getElementById('msg-input');

    // === TABS ===
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const isLogin = tab.dataset.tab === 'login';
        loginForm.style.display = isLogin ? 'block' : 'none';
        registerForm.style.display = isLogin ? 'none' : 'block';
        authStatus.textContent = '';
      });
    });

    // === AUTH ===
    function showStatus(msg, type) {
      authStatus.textContent = msg;
      authStatus.className = 'status-msg ' + type;
    }

    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('reg-email').value;
      const password = document.getElementById('reg-password').value;
      try {
        const res = await fetch(API + '/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Registration failed');
        showStatus('Hero created! Now login.', 'success');
        // Switch to login tab
        document.querySelector('[data-tab="login"]').click();
        document.getElementById('login-email').value = email;
      } catch (err) {
        showStatus(err.message, 'error');
      }
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      try {
        const res = await fetch(API + '/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Login failed');
        token = data.access_token;
        // Decode JWT payload to get user info
        const payload = JSON.parse(atob(token.split('.')[1]));
        currentUser = { id: payload.sub, email: payload.email };
        enterChat();
      } catch (err) {
        showStatus(err.message, 'error');
      }
    });

    document.getElementById('logout-btn').addEventListener('click', () => {
      if (socket) socket.disconnect();
      token = null;
      currentUser = null;
      activeConversationId = null;
      conversations = [];
      authScreen.style.display = 'block';
      chatScreen.style.display = 'none';
    });

    // === ENTER CHAT ===
    function enterChat() {
      authScreen.style.display = 'none';
      chatScreen.style.display = 'block';
      userEmailSpan.textContent = currentUser.email;

      // Connect WebSocket with JWT
      socket = io(window.location.origin, {
        auth: { token },
        query: { token }
      });

      socket.on('connect', () => {
        console.log('Connected to WebSocket');
        socket.emit('getConversations');
      });

      socket.on('conversationsList', (list) => {
        conversations = list;
        renderConversations();
      });

      socket.on('messageHistory', (messages) => {
        renderMessages(messages);
      });

      socket.on('messageSent', (msg) => {
        if (msg.conversationId === activeConversationId) {
          appendMessage(msg);
        }
        // Refresh conversations list
        socket.emit('getConversations');
      });

      socket.on('newMessage', (msg) => {
        if (msg.conversationId === activeConversationId) {
          appendMessage(msg);
        }
        // Refresh conversations list
        socket.emit('getConversations');
      });

      socket.on('openConversation', (data) => {
        openConversation(data.conversationId);
      });

      socket.on('error', (err) => {
        console.error('Socket error:', err);
      });

      socket.on('disconnect', () => {
        console.log('Disconnected from WebSocket');
      });
    }

    // === CONVERSATIONS ===
    function renderConversations() {
      convListEl.innerHTML = '';
      conversations.forEach(conv => {
        const otherUser = conv.userOne.id === currentUser.id ? conv.userTwo : conv.userOne;
        const el = document.createElement('div');
        el.className = 'conv-item' + (conv.id === activeConversationId ? ' active' : '');
        el.textContent = otherUser.email;
        el.addEventListener('click', () => openConversation(conv.id));
        convListEl.appendChild(el);
      });
    }

    function openConversation(convId) {
      activeConversationId = convId;
      noChatMsg.style.display = 'none';
      messagesArea.style.display = 'flex';
      messageBar.style.display = 'flex';
      messagesArea.innerHTML = '';
      renderConversations(); // highlight active
      socket.emit('getMessages', { conversationId: convId });
      msgInput.focus();
    }

    // === START NEW CHAT ===
    document.getElementById('start-chat-btn').addEventListener('click', async () => {
      const email = document.getElementById('new-chat-email').value.trim();
      if (!email) return;
      // We send a "hello" message to start the conversation
      // First we need the recipient's ID ‚Äî we'll send a message via socket
      // The backend will create the conversation automatically
      // But we need the user ID... let's use a simple approach:
      // Send a special first message. The gateway needs recipientId though.
      // So we need an endpoint or a way to find users by email.
      // For MVP: add a quick fetch to find user by email.
      try {
        const res = await fetch(API + '/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password: '___lookup___' })
        });
        // This will fail but we actually need a user lookup endpoint.
        // Let's use the sendMessage with email support instead.
      } catch(e) {}

      // Store email for when we get the user lookup endpoint
      // For now emit sendMessage ‚Äî we'll need to add email-based lookup
      socket.emit('startConversation', { recipientEmail: email });
      document.getElementById('new-chat-email').value = '';
    });

    // === MESSAGES ===
    function renderMessages(messages) {
      messagesArea.innerHTML = '';
      messages.forEach(msg => appendMessage(msg));
    }

    function appendMessage(msg) {
      const el = document.createElement('div');
      const isMine = msg.senderId === currentUser.id;
      el.className = 'message ' + (isMine ? 'mine' : 'theirs');

      const time = new Date(msg.createdAt).toLocaleTimeString('pl-PL', {
        hour: '2-digit', minute: '2-digit'
      });

      el.innerHTML =
        '<span class="sender">' + (isMine ? '‚öîÔ∏è You' : 'üõ°Ô∏è ' + msg.senderEmail) + '</span>' +
        '<span>' + escapeHtml(msg.content) + '</span>' +
        '<span class="time">' + time + '</span>';

      messagesArea.appendChild(el);
      messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // === SEND MESSAGE ===
    function sendMessage() {
      const content = msgInput.value.trim();
      if (!content || !activeConversationId) return;

      // Find recipient from active conversation
      const conv = conversations.find(c => c.id === activeConversationId);
      if (!conv) return;

      const recipientId = conv.userOne.id === currentUser.id
        ? conv.userTwo.id
        : conv.userOne.id;

      socket.emit('sendMessage', { recipientId, content });
      msgInput.value = '';
    }

    document.getElementById('send-btn').addEventListener('click', sendMessage);
    msgInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  </script>
</body>
</html>
